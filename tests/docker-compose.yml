services:
  tidewatch-arm64:
    build:
      context: .
      dockerfile: Dockerfile.arm64
    platform: linux/arm64
    privileged: true
    volumes:
      - ./packages:/packages:ro
      - .:/tests:ro  # Mount current dir (tests/) to /tests in container
      - /sys/fs/cgroup:/sys/fs/cgroup:rw
    tmpfs:
      - /run
      - /run/lock
      - /tmp
    networks:
      - metrics
    stop_signal: SIGRTMIN+3
    tty: true
    stdin_open: true
    command: /lib/systemd/systemd
    healthcheck:
      test: ["CMD", "systemctl", "is-system-running", "--wait"]
      interval: 5s
      timeout: 30s
      retries: 10
      start_period: 10s

  tidewatch-armhf:
    build:
      context: .
      dockerfile: Dockerfile.armhf
    platform: linux/arm/v7
    privileged: true
    volumes:
      - ./packages:/packages:ro
      - .:/tests:ro  # Mount current dir (tests/) to /tests in container
      - /sys/fs/cgroup:/sys/fs/cgroup:rw
    tmpfs:
      - /run
      - /run/lock
      - /tmp
    networks:
      - metrics
    stop_signal: SIGRTMIN+3
    tty: true
    stdin_open: true
    command: /lib/systemd/systemd
    healthcheck:
      test: ["CMD", "systemctl", "is-system-running", "--wait"]
      interval: 5s
      timeout: 30s
      retries: 10
      start_period: 10s

  victoriametrics:
    image: victoriametrics/victoria-metrics:latest
    ports:
      - "8428:8428"
    networks:
      - metrics
    command:
      - --storageDataPath=/victoria-metrics-data
      - --httpListenAddr=:8428

networks:
  metrics:
    driver: bridge
